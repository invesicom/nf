name: Docker Deployment Tests

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'docker/**'
      - 'Dockerfile'
      - '.env.example'
      - 'docker-compose.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'docker/**'
      - 'Dockerfile'
      - '.env.example'
      - 'docker-compose.yml'

jobs:
  docker-config-tests:
    name: Docker Configuration Tests
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.3'
        extensions: mbstring, xml, ctype, iconv, intl, pdo_mysql, dom, filter, gd, json, zip, yaml
    
    - name: Install Composer dependencies
      run: composer install --prefer-dist --no-progress --no-suggest
    
    - name: Run Docker Configuration Tests
      run: php artisan test tests/Unit/DockerConfigurationTest.php --verbose

  docker-build-test:
    name: Docker Build Test
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Test Docker Build
      run: |
        docker build -f docker/Dockerfile -t nullfake-test .
        docker images nullfake-test
    
    - name: Test Docker Compose Configuration
      run: |
        cp .env.example .env
        docker-compose -f docker/docker-compose.yml config

  docker-integration-test:
    name: Docker Integration Test
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Create environment file
      run: |
        cp .env.example .env
        # Set minimal configuration for testing
        echo "OPENAI_API_KEY=test_key" >> .env
        echo "LLM_PRIMARY_PROVIDER=ollama" >> .env
    
    - name: Start Docker services
      run: |
        docker-compose -f docker/docker-compose.yml up -d
        
    - name: Wait for services to be ready
      run: |
        echo "Waiting for services to start..."
        sleep 30
        
    - name: Test service health
      run: |
        # Test database
        docker-compose -f docker/docker-compose.yml exec -T db mysql -u faker -ppassword -e "SELECT 1;"
        
        # Test web server
        curl -f http://localhost:8080 || exit 1
        
        # Test Ollama service
        curl -f http://localhost:11434/api/tags || exit 1
        
    - name: Check container logs
      if: failure()
      run: |
        echo "=== App Logs ==="
        docker-compose -f docker/docker-compose.yml logs app
        echo "=== Nginx Logs ==="
        docker-compose -f docker/docker-compose.yml logs nginx
        echo "=== Database Logs ==="
        docker-compose -f docker/docker-compose.yml logs db
        echo "=== Queue Logs ==="
        docker-compose -f docker/docker-compose.yml logs queue
        
    - name: Cleanup
      if: always()
      run: |
        docker-compose -f docker/docker-compose.yml down -v

  docker-security-scan:
    name: Docker Security Scan
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Build Docker image
      run: docker build -f docker/Dockerfile -t nullfake-security-test .
    
    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: 'nullfake-security-test'
        format: 'sarif'
        output: 'trivy-results.sarif'
    
    - name: Upload Trivy scan results to GitHub Security tab
      uses: github/codeql-action/upload-sarif@v2
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'
